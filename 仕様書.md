# 4人麻雀大会戦レーティングシステム 実装仕様書

## 概要
Google Apps Script (GAS) を用いてGoogleスプレッドシート上で動作する、4人麻雀大会戦のレーティング自動計算・管理システムの仕様書です。

---

## システム全体像
- **対局データ**・**プレイヤー情報**・**管理情報**を各シートで管理
- レーティング計算・更新・エラー通知・データ整合性維持を自動化
- パフォーマンスを重視したバッチ処理とキャッシュ機能を実装
- トランザクション処理により、データの整合性を保証

---

## スプレッドシート構成

### 1. 統計情報（PLAYER_LIST）
| カラム | 項目 | 説明 | インデックス |
|--------|------|------|--------------|
| A | 雀魂ID | プレイヤーID（ユニーク） | PLAYER_COLUMN.ID (0) |
| B | 雀魂名 | プレイヤー名 | PLAYER_COLUMN.NAME (1) |
| C | レーティング | 現在のレーティング | PLAYER_COLUMN.RATING (2) |
| D | 累計対局数 | 総対局数 | PLAYER_COLUMN.GAMES (3) |
| E | 最終対局日時 | 最後の対局日時 | PLAYER_COLUMN.LAST_MATCH_DATE (4) |
| F | 先月末レーティング | 月末時点のレーティング | PLAYER_COLUMN.PREV_MONTH_RATING (5) |
| G | 先月末累計対局数 | 月末時点の対局数 | PLAYER_COLUMN.PREV_MONTH_GAMES (6) |

※空欄セルは自動的に初期値で埋められる（レート: 1500、対局数: 0、日時: 2025/01/01）

### 2. 整形C（MATCH_DATA）
| カラム範囲 | 項目 | インデックス |
|------------|------|--------------|
| A | 開始時間 | MATCH_COLUMN.START_TIME (0) |
| B | 終了時間 | MATCH_COLUMN.END_TIME (1) |
| C-F | 各プレイヤーID | MATCH_COLUMN.PLAYER_IDS (2-5) |
| G-J | 各プレイヤー名 | MATCH_COLUMN.PLAYER_NAMES (6-9) |
| K-N | 各プレイヤー得点 | MATCH_COLUMN.SCORES (10-13) |
| O-R | 各プレイヤースコア | MATCH_COLUMN.FINAL_SCORES (14-17) |

※対局結果は左から順に1位, 2位, 3位, 4位として扱う固定順位方式

### 3. レーティング算出（RATING_CALC）
| セル | 項目 | 説明 |
|------|------|------|
| A1 | 最終更新日時（表示用） | 「更新日時：yyyy/MM/dd HH:mm:ss」形式 |
| B1 | 最終処理日時（内部用） | システムが参照する実際の処理日時 |
| A3以降 | レーティングランキング | **GASでは変更しない（手動管理部分）** |

---

## ファイル構成（全8ファイル）

### メインファイル（3ファイル）
- `Code.gs` : エントリーポイント・メニュー設定・メイン処理
- `RatingSystem.gs` : レーティング計算ロジック・対局データ処理
- `PlayerManager.gs` : プレイヤー情報管理・データ更新

### ユーティリティ（3ファイル）
- `Config.gs` : 定数定義・設定値
- `SheetManager.gs` : シート操作・バッチ読み書き
- `Utils.gs` : 共通ユーティリティ・日付処理・データ検証

### テスト（2ファイル）
- `Test.gs` : テスト実行・デバッグ関数
- `TestData.gs` : テストデータ生成

---

## レーティング計算ロジック

### レーティング定数（RATING_CONFIG）
```javascript
const RATING_CONFIG = {
  INITIAL_RATING: 1500,              // 初期レーティング
  PLACEMENT_POINTS: [30, 10, -10, -30], // 順位点（1位〜4位）
  CORRECTION_FACTOR: 40,              // 平均レート補正係数
  GAMES_FACTOR: 0.002,                // 対局数係数
  MIN_CORRECTION: 0.2,                // 最小補正値
  MAX_CORRECTION_GAMES: 300           // 最大補正対局数
};
```

### 計算式
```javascript
function calculateRatingChange(player, placement, tableAvgRating) {
  // 1. 順位点
  const placementPoint = RATING_CONFIG.PLACEMENT_POINTS[placement - 1];

  // 2. 平均レート補正
  const avgRatingCorrection = (tableAvgRating - player.rating) / RATING_CONFIG.CORRECTION_FACTOR;

  // 3. 対局数補正
  let gamesCorrection;
  if (player.gamesPlayed < RATING_CONFIG.MAX_CORRECTION_GAMES) {
    gamesCorrection = 1 - (player.gamesPlayed * RATING_CONFIG.GAMES_FACTOR);
  } else {
    gamesCorrection = RATING_CONFIG.MIN_CORRECTION;
  }

  // 4. レート変動計算
  const ratingChange = gamesCorrection * (placementPoint + avgRatingCorrection);

  return ratingChange;
}
```

---

## 処理フロー

### 1. メイン処理（processRatings）
```javascript
1. データ読み込み（バッチ処理）
   - プレイヤーデータの一括読み込み → Mapでキャッシュ
   - 対局データの一括読み込み
   - 最終更新日時の取得
2. 対局処理
   - 新規対局の抽出（findNewMatches）
   - レーティング計算（calculateRatings）
   - 更新データの蓄積
3. 一括更新（全処理成功時のみ）
   - プレイヤー情報の一括更新
   - 最終更新日時の記録
4. 結果表示
   - console.logで処理結果出力
   - エラーがあればユーザー通知
```

### 2. データ検証（validateData）
```javascript
1. 対局データの必須チェック
   - 日時・プレイヤーID・スコアの存在確認
   - プレイヤーIDの重複チェック
2. 簡易データ整合性チェック
   - 数値フィールドの型確認
```

### 3. バッチ処理最適化
```javascript
1. 読み込み: getRange().getValues() で一括読み込み
2. 書き込み: setValues() で一括書き込み
3. キャッシュ: プレイヤー情報をMapオブジェクトで管理
```

---

## パフォーマンス最適化

### 1. 高速処理の実装
- バッチ読み書きによるAPI呼び出し回数最小化
- Mapオブジェクトによる高速検索
- 配列操作による効率的なデータ処理

### 2. シンプルな設計
- 最小限の機能に絞った実装
- 分割処理なし（更新日時以降の差分処理）
- 複雑な制御フローの回避

---

## テスト戦略

### 1. 基本テスト
- レーティング計算ロジックのテスト
- データ検証機能のテスト

### 2. テストデータ
- サンプルプレイヤー10名
- サンプル対局30局

---

## 実行環境と制約

### GAS制限事項
- 実行時間: 最大6分（手動実行）
- メモリ: 最大50MB
- 更新日時以降の差分処理により制約内で動作

---

## 初期セットアップ

1. Googleスプレッドシートの作成
2. 必要なシート（統計情報・整形C・レーティング算出）の準備
3. GASエディタでコードを配置
4. 初回実行と権限承認
5. メニューから手動実行

---

## まとめ
本システムは、4人麻雀の大会戦レーティングを自動計算・管理するGAS実装のシステムです。パフォーマンス最適化、エラーハンドリング、データ保護を重視し、安定した運用を実現します。
