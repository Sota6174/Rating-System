# 4人麻雀大会戦レーティングシステム 実装仕様書

## 概要
Google Apps Script (GAS) を用いてGoogleスプレッドシート上で動作する、4人麻雀大会戦のレーティング自動計算・管理システムの仕様書です。

---

## システム全体像
- **対局データ**・**プレイヤー情報**・**管理情報**を各シートで管理
- レーティング計算・更新・エラー通知・データ整合性維持を自動化
- 実装は`rating_system.js`、設定は`rating_config.js`、UI関連は`rating_ui.js`、デバッグは`debug.js`で管理

---

## スプレッドシート構成

### 1. 統計情報（PLAYER_LIST）
- 雀魂ID（ユニーク）：PLAYER_COLUMN.ID (0)
- 雀魂名：PLAYER_COLUMN.NAME (1)
- レーティング：PLAYER_COLUMN.RATING (2)
- 累計対局数：PLAYER_COLUMN.GAMES (3)
- 最終対局日時：PLAYER_COLUMN.LAST_MATCH_DATE (4)
- 先月末レーティング：PLAYER_COLUMN.PREV_MONTH_RATING (5)
- 先月末累計対局数：PLAYER_COLUMN.PREV_MONTH_GAMES (6)
- ※空欄セルは自動的に初期値で埋められる（レート: 1500、対局数: 0、日時: 2025/05/01）

### 2. 整形C（MATCH_DATA）
- 開始時間：MATCH_COLUMN.START_TIME (0)
- 終了時間：MATCH_COLUMN.END_TIME (1)
- 各プレイヤーのID (2-5)、名前 (6-9)、得点 (10-13)、スコア (14-17)
- 対局結果は左から順に1位, 2位, 3位, 4位として扱う固定順位方式
- 最終更新日時以降の対局のみ処理対象

### 3. レーティング算出（RATING_CALC）
- A1セルに「更新日時：yyyy/MM/dd HH:mm:ss」形式で最終更新日時を記録
- この日時は処理対象の対局を決定する基準として使用

---

## ファイル構成
- `rating_system.js` : メイン処理・エラー通知・空欄補完・バッチ処理
- `rating_config.js` : 定数・設定値（シート名・カラム番号・レート計算定数など）
- `rating_ui.js` : UIメニュー・結果表示機能
- `debug.js` : シンプルなデバッグ関数群（シート書き換えなし、主ロジックのみテスト）
- `month_end_process.js` : 月末更新処理（統計情報更新・履歴追加・シートコピー等）

---

## レーティング計算ロジック

### レーティング定数（RATING_CONFIG）
- 初期レーティング：1500
- 順位点：[30, 10, -10, -30]（1位、2位、3位、4位）
- 補正係数：40（平均レートとの差を補正）
- 対局数係数：0.002（対局数による補正）
- 最小補正値：0.2（対局数が多い場合）
- 最大補正対局数：300（この対局数以上で最小補正値が適用）

### 計算式
1. 卓の平均レート = 参加プレイヤーのレートの合計 ÷ 4
2. 平均レート補正 = (平均レート - プレイヤーレート) ÷ 補正係数
3. 対局数補正 =
   - 対局数 < 最大補正対局数の場合：(1 - 対局数 × 対局数係数)
   - それ以外の場合：最小補正値(0.2)
4. レート変動 = 対局数補正 × (順位点 + 平均レート補正)
5. 新レーティング = 現在レーティング + レート変動

---

## 主な処理フロー

### 1. メニュー追加（onOpen）
- スプレッドシートに「レーティングシステム」メニューを追加
- 「レーティング計算実行」から`processRatings`を呼び出し

### 2. レーティング計算（calculateRating）
- 卓の平均レート算出
- 各プレイヤーの順位に応じた順位点取得
- 平均レートとプレイヤーレートの差による補正
- 対局数に応じた補正係数適用
- 最終的なレート変動を計算し、新レートを算出

### 3. プレイヤー情報更新（updatePlayerInfo）
- 既存/新規プレイヤーを分類
- 既存プレイヤー（updateAllPlayers）：
  - IDで検索できるようマップに変換
  - 行インデックスを基に対象行のデータを一括更新
- 新規プレイヤー（addNewPlayers）：
  - 最初の空白行（findFirstEmptyRow）を検出
  - 新規プレイヤーデータを連続した行に一括挿入

### 4. 最終更新日時管理
- `getLastProcessTime`：
  - B1セルから内部処理用更新日時を取得
  - 日時フォーマットチェックと変換
  - 不正な形式の場合はエラー通知
- `recordLastProcessTime`：
  - 最新の対局終了時刻（または現在時刻）を記録
  - プリフィックス付きでA1セルに書き込み
  - 更新時には処理基準時刻も更新

### 5. 対局データ処理（processRatings）
- メインシートからデータ読み込み
- 最終更新日時以降の対局のみ抽出（findNewMatches）
- 各対局ごとに：
  - プレイヤーデータ取得（getPlayerData）
  - レーティング計算（calculateRating）
  - 更新対象プレイヤー情報を記録
- エラーが発生した場合はユーザーに通知し処理中断
- 問題なければプレイヤー情報を更新（updatePlayerInfo）
- 最終更新日時を最新の対局終了時刻に更新

---

## エラーハンドリング
- エラー発生時はLogger.logでログに記録し、詳細情報を保存
- エラー内容はユーザーに明示的に通知
- 対局処理中の部分的なエラーは記録し、すべての処理完了後にまとめて通知
- エラーが1件でもあればスプレッドシートの更新は行わない

---

## ログ機能
- GASのLogger.logを使用してログを出力
- エラーログには「✗」プレフィックスを付けて視覚的に区別
- コンソールに処理経過が逐次表示される

---

## UI機能（rating_ui.js）
- メニュー管理：
  - スプレッドシートに「レーティングシステム」メニューを追加
- 結果表示：
  - 処理結果をダイアログで表示
  - エラーメッセージ表示
  - 処理完了メッセージ表示

---

## 実行環境と制約
- Google Apps Script環境で動作
- バッチ処理を活用してAPI呼び出し回数を最小化

---

## まとめ
- 4人麻雀の大会戦レーティングを自動計算・管理するシステム
- レーティング計算は順位点・平均レート補正・対局数補正を考慮
