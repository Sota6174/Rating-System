# 4人麻雀レーティングシステム

Google Apps Script (GAS) を用いた、4人麻雀大会戦のレーティング自動計算・管理システム

## 📋 概要

Googleスプレッドシート上で動作する麻雀レーティングシステムです。Eloレーティングベースの独自計算式により、対局結果から自動的にプレイヤーのレーティングを計算・更新します。

## ✨ 主な機能

- **レーティング自動計算** - 順位点・平均レート補正・対局数補正を考慮した独自アルゴリズム
- **差分処理** - 最終更新日時以降の対局のみを効率的に処理
- **バッチ処理最適化** - API呼び出し回数を最小化した高速処理
- **プレイヤー管理** - 新規プレイヤーの自動検出・追加
- **UI統合** - スプレッドシートメニューからの簡単操作
- **テスト機能** - サンプルデータ生成・包括的テストスイート

## 🚀 クイックスタート

### 1. 前提条件
- Googleアカウント
- Googleスプレッドシートへのアクセス権
- Google Apps Scriptの基本的な知識

### 2. セットアップ手順

#### ステップ1: スプレッドシート作成
1. 新しいGoogleスプレッドシートを作成
2. 以下の3つのシートを作成：
   - `統計情報` - プレイヤー情報管理
   - `整形C` - 対局データ記録
   - `レーティング算出` - システム管理用

#### ステップ2: シート構造設定

**統計情報シート**
| A列 | B列 | C列 | D列 | E列 | F列 | G列 |
|-----|-----|-----|-----|-----|-----|-----|
| 雀魂ID | 雀魂名 | レーティング | 累計対局数 | 最終対局日時 | 先月末レーティング | 先月末累計対局数 |

**整形Cシート**
| A列 | B列 | C～F列 | G～J列 | K～N列 | O～R列 |
|-----|-----|--------|--------|--------|--------|
| 開始時間 | 終了時間 | プレイヤーID | プレイヤー名 | 得点 | スコア |

**レーティング算出シート**
| A1セル | B1セル |
|--------|--------|
| 表示用更新日時 | 内部用更新日時 |

#### ステップ3: GASコード配置
1. スプレッドシートから「拡張機能」→「Apps Script」を選択
2. 以下の8つのファイルをコピー：
   - `Code.gs` - メインエントリーポイント
   - `Config.gs` - 設定定数
   - `Utils.gs` - ユーティリティ関数
   - `SheetManager.gs` - シート操作
   - `RatingSystem.gs` - レーティング計算
   - `PlayerManager.gs` - プレイヤー管理
   - `TestData.gs` - テストデータ生成
   - `Test.gs` - テスト・デバッグ

#### ステップ4: 初期実行
1. GASエディタで`Code.gs`の`onOpen()`関数を実行
2. 必要な権限を承認
3. スプレッドシートを再読み込み
4. 「レーティングシステム」メニューが表示されることを確認

## 📖 使用方法

### 基本操作

1. **テストデータ生成**
   ```
   メニュー → レーティングシステム → テストデータ生成
   ```
   - 10名のサンプルプレイヤー
   - 30局のサンプル対局データを自動生成

2. **レーティング計算実行**
   ```
   メニュー → レーティングシステム → レーティング計算実行
   ```
   - 新規対局データを自動処理
   - プレイヤーレーティングを更新

3. **統計情報表示**
   ```
   メニュー → レーティングシステム → プレイヤー統計表示
   ```
   - 全プレイヤーの統計情報
   - レーティングランキング

### 対局データ入力

**整形Cシート**に以下の形式でデータを入力：

| 開始時間 | 終了時間 | 1位ID | 2位ID | 3位ID | 4位ID | 1位名 | 2位名 | 3位名 | 4位名 | 1位得点 | 2位得点 | 3位得点 | 4位得点 | 1位スコア | 2位スコア | 3位スコア | 4位スコア |
|----------|----------|--------|--------|--------|--------|--------|--------|--------|--------|----------|----------|----------|----------|----------|----------|----------|----------|
| 2025/1/13 19:00 | 2025/1/13 20:30 | player001 | player002 | player003 | player004 | 山田太郎 | 佐藤花子 | 田中次郎 | 鈴木美咲 | 45000 | 30000 | 15000 | 10000 | 48000 | 31000 | 14000 | 7000 |

## 🎯 レーティング計算仕様

### 基本設定
- **初期レーティング**: 1500
- **順位点**: [30, 10, -10, -30] (1位～4位)
- **補正係数**: 40
- **対局数係数**: 0.002
- **最小補正値**: 0.2
- **最大補正対局数**: 300

### 計算式
```javascript
// 1. 順位点
placementPoint = [30, 10, -10, -30][placement - 1]

// 2. 平均レート補正
avgRatingCorrection = (tableAvgRating - playerRating) / 40

// 3. 対局数補正
gamesCorrection = player.games < 300 ?
    (1 - player.games * 0.002) : 0.2

// 4. 最終レート変動
ratingChange = gamesCorrection * (placementPoint + avgRatingCorrection)

// 5. 新レーティング
newRating = currentRating + ratingChange
```

## 🧪 テスト・デバッグ

### テスト実行
```
メニュー → レーティングシステム → テスト実行
```

### 含まれるテスト
- **単体テスト**: ユーティリティ関数・レーティング計算・データ検証
- **統合テスト**: エンドツーエンドの処理フロー
- **パフォーマンステスト**: 大量データでの動作確認

### デバッグ情報
- コンソールログ出力
- エラー詳細表示
- 処理時間計測

## ⚡ パフォーマンス

### 最適化機能
- **バッチ読み書き**: `getRange().getValues()`による一括処理
- **Mapオブジェクト**: プレイヤー情報の高速検索
- **差分処理**: 更新日時以降のデータのみ処理
- **トランザクション**: 全処理成功時のみ更新

### 処理能力
- **対局数**: 100局/分 (目安)
- **プレイヤー数**: 1000名まで対応
- **メモリ使用量**: 50MB以内
- **実行時間**: 6分以内 (GAS制限)

## 🔧 カスタマイズ

### 設定変更
`Config.gs`で以下の値を調整可能：

```javascript
const RATING_CONFIG = {
  INITIAL_RATING: 1500,              // 初期レーティング
  PLACEMENT_POINTS: [30, 10, -10, -30], // 順位点
  CORRECTION_FACTOR: 40,              // 補正係数
  GAMES_FACTOR: 0.002,                // 対局数係数
  MIN_CORRECTION: 0.2,                // 最小補正値
  MAX_CORRECTION_GAMES: 300           // 最大補正対局数
};
```

### シート名変更
```javascript
const SHEET_NAMES = {
  PLAYER_LIST: '統計情報',
  MATCH_DATA: '整形C',
  RATING_CALC: 'レーティング算出'
};
```

## 🐛 トラブルシューティング

### よくある問題

**Q: メニューが表示されない**
A: GASエディタで`onOpen()`関数を手動実行し、スプレッドシートを再読み込みしてください

**Q: 権限エラーが発生する**
A: GAS実行時の権限承認ダイアログで「許可」を選択してください

**Q: レーティングが更新されない**
A: 対局データの日時が最終更新日時より新しいことを確認してください

**Q: エラーが発生する**
A: コンソールログ（Ctrl+Shift+I）でエラー詳細を確認してください

### サポート
- Issues: プロジェクトのGitHubリポジトリ
- ログ確認: GASエディタの実行ログ
- テスト実行: メニューの「テスト実行」で動作確認

## 📁 プロジェクト構成

```
rating-system/
├── README.md           # このファイル
├── 仕様書.md           # 詳細仕様
├── memo.md            # PR用文章
├── Code.gs            # メインエントリーポイント
├── Config.gs          # 設定定数
├── Utils.gs           # ユーティリティ関数
├── SheetManager.gs    # シート操作
├── RatingSystem.gs    # レーティング計算
├── PlayerManager.gs   # プレイヤー管理
├── TestData.gs        # テストデータ生成
├── Test.gs            # テスト・デバッグ
└── .gitignore         # Git除外設定
```

## 📊 システム要件

### 動作環境
- Google Apps Script
- Googleスプレッドシート
- 対応ブラウザ: Chrome, Firefox, Safari, Edge

### 制限事項
- 実行時間: 最大6分 (手動実行)
- メモリ: 最大50MB
- API呼び出し: 1日あたりの制限あり

## 🤝 コントリビューション

### 開発環境
1. リポジトリをクローン
2. GASエディタで開発
3. テストを実行して動作確認
4. プルリクエストを作成

### コーディング規約
- JSDoc形式のコメント
- 関数名はcamelCase
- 定数は UPPER_SNAKE_CASE
- エラーハンドリングの実装

## 📜 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 📞 お問い合わせ

- GitHub Issues: バグレポート・機能要望
- Email: プロジェクト管理者まで

---

**バージョン**: 1.0.0
**最終更新**: 2025年1月13日
**開発者**: Claude Code Assistant